name: Upload Gradle build scans to ge.armeria.dev

on:
  workflow_run:
    workflows: ["actions_build.yml"]
    types:
      - completed

env:
  LC_ALL: "en_US.UTF-8"
  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
  ACTIONS_STEP_DEBUG: true
  GH_TOKEN: ${{ github.token }}
  GH_DEBUG: true

jobs:
  upload-gradle-build-scan:
    name: Upload Gradle build scans
    # TODO(ikhoon): Uncomment this after testing
#    if: github.repository == 'line/armeria'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - id: setup-jdk-19
        name: Set up JDK 19
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '19'

      - id: get-run-id
        name: Get run ID
        run: |
          gh pr checks ${{ github.event.check_run.pull_requests[0].number }} -R ikhoon/armeria | \
          grep runs | \
          head -n 1 | \
          sed 's/.*runs\/\([0-9]*\)\/.*/CHECK_RUN_ID=\1/' >> "$GITHUB_OUTPUT" || true
        shell: bash

      - id: sleep
        name: Wait for artifacts to be updated
        # TODO(ikhoon): Back to 120 seconds after testing
        run: sleep 40
        shell: bash

      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow_conclusion: ""
          run_id: ${{ steps.get-run-id.outputs.CHECK_RUN_ID }}
          name: build-scan.*
          name_is_regexp: true
          path: build/build-scans
          check_artifacts: true
          search_artifacts: true

      - id: upload-build-scans
        name: Upload build scans
        run: |
          DOWNLOAD_DIR="build/build-scans/"
          BUILD_SCAN_DIR="${HOME}/.gradle/build-scan-data"
          BUILD_SCANS=""
          echo "## download dir: $DOWNLOAD_DIR"
          ls -al $DOWNLOAD_DIR
          mkdir -p $BUILD_SCAN_DIR
          for scan in $(ls $DOWNLOAD_DIR) ; do
            rm -rf $BUILD_SCAN_DIR
            cp -r "${DOWNLOAD_DIR}${scan}/" $BUILD_SCAN_DIR
            ./gradlew --no-daemon --stacktrace buildScanPublishPrevious
            BUILD_SCANS="$scan $(cat build/build-scan-url.txt)"$'\n'"${BUILD_SCANS}"
          done
          echo "BUILD_SCANS=${BUILD_SCANS}" >> "$GITHUB_OUTPUT"
          echo "### Gradle build scans" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo $BUILD_SCANS | sed 's/^/- /' | >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v3

      - id: create-or-update-comment
        name: Create or update comment
        working-directory: .github/actions
        run: |
          export NVM_DIR=~/.nvm
          source ~/.nvm/nvm.sh
          npm install
          npm run comment-build-scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_SCANS: ${{ steps.upload-build-scans.outputs.BUILD_SCANS }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ steps.get-run-id.outputs.CHECK_RUN_ID }}
          PR_NUMBER: ${{ github.event.check_run.pull_requests[0].number }}
